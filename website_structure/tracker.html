<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Allowance Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        h1 {
            text-align: center;
        }

        h3 {
            text-align: center;
            color: green;
        }

        form {
            margin-bottom: 20px;
            text-align: center;
        }

        ul {
            list-style-type: none;
            padding: 0;
            margin-top: 10px;
        }

        li {
            margin-bottom: 5px;
        }

        button {
            margin: 5px;
        }
    </style>
</head>
<body>

<h1>Allowance Tracker</h1>

<h3>Total Allowance: <span id="totalDisplay"></span> YEN</h3>

<form id="amountForm">
    <label for="amount">Enter Amount:</label>
    <input type="number" id="amount" required>
</form>

<form id="commentForm">
    <label for="comment">Comment:</label>
    <input type="text" id="comment">
</form>

<form id="passwordForm">
    <label for="password">Set Password:</label>
    <input type="password" id="password" required>
</form>

<button type="button" onclick="addAllowance()">Use Allowance</button>
<button type="button" onclick="subtractAllowance()">Spend Allowance</button>
<button type="button" onclick="showSetPasswordDialog()">Set Password</button>
<button type="button" onclick="confirmResetData()">Reset Data</button>
<button type="button" onclick="downloadLog()">Download Log</button>

<h3>History Log:</h3>
<ul id="historyLogList"></ul>

<script>
    let localData = JSON.parse(localStorage.getItem('localData')) || {
        total: 0,
        password: null,
        passwordSet: false,
        historyLog: []
    };

    let total = localData.total;
    let password = localData.password;
    let passwordSet = localData.passwordSet;
    let historyLog = localData.historyLog;

    updateTotalDisplay();
    updateHistoryLog();

    function updateTotalDisplay() {
        document.getElementById('totalDisplay').textContent = total;
    }

    function updateTotal() {
        updateTotalDisplay();
        document.getElementById('amount').value = '';
        document.getElementById('comment').value = '';
        document.getElementById('password').value = '';
    }

    function addAllowance() {
        const amount = parseInt(document.getElementById('amount').value) || 0;
        const comment = document.getElementById('comment').value;
        total += amount;
        addToHistoryLog(`Used ${amount} YEN - ${comment}`);
        updateTotal();
        saveLocalData();
    }

    function subtractAllowance() {
        const amount = parseInt(document.getElementById('amount').value) || 0;
        const comment = document.getElementById('comment').value;
        total -= amount;
        addToHistoryLog(`Spent ${amount} YEN - ${comment}`);
        updateTotal();
        saveLocalData();
    }

    function setPassword() {
        const newPassword = prompt("Set Password:");
        if (newPassword !== null) {
            password = newPassword;
            passwordSet = true;
            alert("Password set successfully!");
        }
    }

    function showSetPasswordDialog() {
        if (!passwordSet) {
            setPassword();
            saveLocalData();
        } else {
            alert("Password already set. Please use 'Reset Data'.");
        }
    }

    function confirmResetData() {
        const confirmation = confirm("Are you sure you will delete ALL data?");
        if (confirmation) {
            resetData();
        }
    }

    function resetData() {
        total = 0;
        password = null;
        passwordSet = false;
        historyLog = [];
        saveLocalData();
        alert("Data reset successfully!");
        updateHistoryLog();
        location.reload();
    }

    function addToHistoryLog(message) {
        const logEntry = {
            timestamp: new Date().toLocaleString(),
            message: message
        };
        historyLog.push(logEntry);
        updateHistoryLog();
    }

    function updateHistoryLog() {
        const ul = document.getElementById('historyLogList');
        ul.innerHTML = '';
        for (const logEntry of historyLog) {
            const li = document.createElement('li');
            li.textContent = `${logEntry.timestamp} - ${logEntry.message}`;
            ul.appendChild(li);
        }
    }

    function downloadLog() {
        const logContent = historyLog.map(entry => `${entry.timestamp} - ${entry.message}`).join('\n');
        const blob = new Blob([logContent], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'allowance_log.txt';
        a.click();
    }

    function saveLocalData() {
        localData = {
            total: total,
            password: password,
            passwordSet: passwordSet,
            historyLog: historyLog
        };
        localStorage.setItem('localData', JSON.stringify(localData));
    }
</script>

</body>
</html>
